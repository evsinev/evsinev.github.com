
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>handler-socket - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="Building Handlersocket Handlersocket mainly consists of libhsclient, handlersocket, and C++/Perl clients. libhsclient is a common library shared &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://evsinev.github.com/blog/2013/03/31/handler-socket">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/evsinev/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/evsinev/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:evsinev.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Handler-socket</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-31T16:16:00+04:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><ol>
<li>Building Handlersocket</li>
</ol>


<p> Handlersocket mainly consists of libhsclient, handlersocket, and C++/Perl clients. libhsclient is a common library shared from both client and server(plugin). handlersocket is a MySQL daemon plugin.
 To build Handlersocket, you need both MySQL source code and MySQL binary. It is not required to pre-build MySQL source code, but source itself is needed because Handlersocket depends on MySQL header files that only MySQL source distribution contains. MySQL binary is just a normal MySQL binary distribution. You can use official MySQL binaries provided by Oracle.
 Since Handlersocket uses daemon plugin interface supported from MySQL 5.1,
MySQL 5.1 or higher version is required.
 Please make sure that you use identical MySQL version between MySQL source
and MySQL binary. Otherwise you might encounter serious problems (i.e. server
crash, etc).
 Here are steps to build Handlersocket.</p>

<ul>
<li><p>Get MySQL source code</p></li>
<li><p>Get MySQL binary</p></li>
<li><p>Build Handlersocket
$ ./autogen.sh
$ ./configure &#8211;with-mysql-source=/work/mysql-5.1.50 &#8211;with-mysql-bindir=/work/mysql-5.1.50-linux-x86_64-glibc23/bin  &#8211;with-mysql-plugindir=/work/mysql-5.1.50-linux-x86_64-glibc23/lib/plugin</p></li>
</ul>


<p> &#8211;with-mysql-source refers to the top of MySQL source directory (which
contains the VERSION file or the configure.in file), &#8211;with-mysql-bindir
refers to where MySQL binary executables (i.e. mysql_config) are located,
and &#8211;with-mysql-plugindir refers to a plugin directory where plugin
libraries (*.so) are installed.</p>

<p>  $ make
  $ sudo make install</p>

<p> Both libhsclient and the handlersocket plugin will be installed.</p>

<ol>
<li>Using Handlersocket</li>
</ol>


<p>Append configuration options for handlersocket to my.cnf.</p>

<p>  [mysqld]
  loose_handlersocket_port = 9998</p>

<pre><code># the port number to bind to (for read requests)
</code></pre>

<p>  loose_handlersocket_port_wr = 9999</p>

<pre><code># the port number to bind to (for write requests)
</code></pre>

<p>  loose_handlersocket_threads = 16</p>

<pre><code># the number of worker threads (for read requests)
</code></pre>

<p>  loose_handlersocket_threads_wr = 1</p>

<pre><code># the number of worker threads (for write requests)
</code></pre>

<p>  open_files_limit = 65535</p>

<pre><code># to allow handlersocket accept many concurrent
# connections, make open_files_limit as large as
# possible.
</code></pre>

<p>Log in to mysql as root, and execute the following query.</p>

<p>  mysql> install plugin handlersocket soname &#8216;handlersocket.so&#8217;;</p>

<p>If handlersocket.so is successfully installed, it starts
accepting connections on port 9998 and 9999. Running
&#8216;show processlist&#8217; should show handlersocket worker threads.</p>

<hr />

<p>On the client side, you need to install libhsclient for c++ apps
and perl-Net-HandlerSocket for perl apps. They do not require
MySQL to compile.</p>

<p>  $ ./autogen.sh
  $ ./configure &#8211;disable-handlersocket-server
  $ make
  $ sudo make install
  $ cd perl-Net-HandlerSocket
  $ perl Makefile.PL
  $ make
  $ sudo make install</p>

<hr />

<p>Alternatively, you can use the rpm installation. If your OS
supports rpms, you can use the following commands to build and
install handlersocket rpm packages.</p>

<p>(Server side, installs HandlerSocket plugin)
  $ ./autogen.sh
  $ ./configure &#8211;with-mysql-source=/work/mysql-5.1.50 &#8211;with-mysql-bindir=/work/mysql-5.1.50-linux-x86_64-glibc23/bin  &#8211;with-mysql-plugindir=/work/mysql-5.1.50-linux-x86_64-glibc23/lib/plugin
  $ make rpm_cli
  $ sudo rpm -U dist/RPMS/<em>/libhsclient</em>.rpm
  $ make rpm_c
  $ sudo rpm -U dist/RPMS/<em>/handlersocket</em>.rpm</p>

<p>(Client side, installs client libraries)
  $ ./autogen.sh
  $ ./configure &#8211;disable-handlersocket-server
  $ make rpm_cli
  $ sudo rpm -U dist/RPMS/<em>/libhsclient</em>.rpm
  $ make rpm_perl
  $ sudo rpm -U dist/RPMS/<em>/perl-Net-HandlerSocket</em>.rpm</p>

<hr />

<p>The HandlerSocket protocol</p>

<hr />

<p>Basic syntax</p>

<ul>
<li>The HandlerSocket protocol is line-based. Each line ends with LF(0x0a).</li>
<li>Each line consists a concatenation of tokens separated by HT(0x09).</li>
<li>A token is either NULL or an encoded string. Note that you need to
distinguish NULL from an empty string, as most DBMs does so.</li>
<li>NULL is expressed as a single NUL(0x00).</li>
<li>An encoded string is a string with the following encoding rules.

<ul>
<li>Characters in the range [0x10 - 0xff] are encoded as itselves.</li>
<li>A character in the range [0x00 - 0x0f] is prefixed by 0x01 and
shifted by 0x40. For example, 0x03 is encoded as 0x01 0x43.</li>
</ul>
</li>
<li>Note that a string can be empty. A continuation of 0x09 0x09 means that
there is an empty string between them. A continuation of 0x09 0x0a means
that there is an empty string at the end of the line.</li>
</ul>


<hr />

<p>Request and Response</p>

<ul>
<li>The HandlerSocket protocol is a simple request/response protocol. After a
connection is established, the client side sends a request, and then the
server side sends a response.</li>
<li>A request/response consists of a single line.</li>
<li>Requests can be pipelined; That is, you can send multiple requests (ie.
lines) at one time, and receive responses for them at one time.</li>
</ul>


<hr />

<p>Opening index</p>

<p>The &#8216;open_index&#8217; request has the following syntax.</p>

<pre><code>P &lt;indexid&gt; &lt;dbname&gt; &lt;tablename&gt; &lt;indexname&gt; &lt;columns&gt; [&lt;fcolumns&gt;]
</code></pre>

<ul>
<li><indexid> is a number in decimal.</li>
<li><dbname>, <tablename>, and <indexname> are strings. To open the primary
key, use PRIMARY as <indexname>.</li>
<li><columns> is a comma-separated list of column names.</li>
<li><fcolumns> is a comma-separated list of column names. This parameter is
optional.</li>
</ul>


<p>Once an &#8216;open_index&#8217; request is issued, the HandlerSocket plugin opens the
specified index and keep it open until the client connection is closed. Each
open index is identified by <indexid>. If <indexid> is already open, the old
open index is closed. You can open the same combination of <dbname>
<tablename> <indexname> multple times, possibly with different <columns>.
For efficiency, keep <indexid> small as far as possible.</p>

<hr />

<p>Getting data</p>

<p>The &#8216;find&#8217; request has the following syntax.</p>

<pre><code>&lt;indexid&gt; &lt;op&gt; &lt;vlen&gt; &lt;v1&gt; ... &lt;vn&gt; [LIM] [IN] [FILTER ...]
</code></pre>

<p>LIM is a sequence of the following parameters.</p>

<pre><code>&lt;limit&gt; &lt;offset&gt;
</code></pre>

<p>IN is a sequence of the following parameters.</p>

<pre><code>@ &lt;icol&gt; &lt;ivlen&gt; &lt;iv1&gt; ... &lt;ivn&gt;
</code></pre>

<p>FILETER is a sequence of the following parameters.</p>

<pre><code>&lt;ftyp&gt; &lt;fop&gt; &lt;fcol&gt; &lt;fval&gt;
</code></pre>

<ul>
<li><indexid> is a number. This number must be an <indexid> specified by a
&#8216;open_index&#8217; request executed previously on the same connection.</li>
<li><op> specifies the comparison operation to use. The current version of
HandlerSocket supports &#8216;=&#8217;, &#8216;>&#8217;, &#8216;>=&#8217;, &#8216;&lt;&#8217;, and &#8216;&lt;=&#8217;.</li>
<li><vlen> indicates the length of the trailing parameters <v1> &#8230; <vn>. This
must be smaller than or equal to the number of index columns specified by
the <indexname> parameter of the corresponding &#8216;open_index&#8217; request.</li>
<li><v1> &#8230; <vn> specify the index column values to fetch.</li>
<li>LIM is optional. <limit> and <offset> are numbers. When omitted, it works
as if 1 and 0 are specified. These parameter works like LIMIT of SQL.
These values don&#8217;t include the number of records skipped by a filter.</li>
<li>IN is optional. It works like WHERE &#8230; IN syntax of SQL. <icol> must be
smaller than the number of index columns specified by the <indexname>
parameter of the corresponding &#8216;open_index&#8217; request. If IN is specified in
a find request, the <icol>-th parameter value of <v1> &#8230;  <vn> is ignored.</li>
<li>FILTERs are optional. A FILTER specifies a filter. <ftyp> is either &#8216;F&#8217;
(filter) or &#8216;W&#8217; (while). <fop> specifies the comparison operation to use.
<fcol> must be smaller than the number of columns specified by the
<fcolumns> parameter of the corresponding &#8216;open_index&#8217; request. Multiple
filters can be specified, and work as the logical AND of them. The
difference of &#8216;F&#8217; and &#8216;W&#8217; is that, when a record does not meet the
specified condition, &#8216;F&#8217; simply skips the record, and &#8216;W&#8217; stops the loop.</li>
</ul>


<hr />

<p>Updating/Deleting data</p>

<p>The &#8216;find_modify&#8217; request has the following syntax.</p>

<pre><code>&lt;indexid&gt; &lt;op&gt; &lt;vlen&gt; &lt;v1&gt; ... &lt;vn&gt; [LIM] [IN] [FILTER ...] MOD
</code></pre>

<p>MOD is a sequence of the following parameters.</p>

<pre><code>&lt;mop&gt; &lt;m1&gt; ... &lt;mk&gt;
</code></pre>

<ul>
<li><mop> is &#8216;U&#8217; (update), &#8216;+&#8217; (increment), &#8216;-&#8217; (decrement), &#8216;D&#8217; (delete),
&#8216;U?&#8217;, &#8216;+?&#8217;, &#8216;-?&#8217;, or &#8216;D?&#8217;. If the &#8216;?&#8217; suffix is specified, it returns
the contents of the records before modification (as if it&#8217;s a &#8216;find&#8217;
request), instead of the number of modified records.</li>
<li><m1> &#8230; <mk> specifies the column values to set. The length of <m1> &#8230;
<mk> must be smaller than or equal to the length of <columns> specified by
the corresponding &#8216;open_index&#8217; request. If <mop> is &#8216;D&#8217;, these parameters
are ignored. If <mop> is &#8216;+&#8217; or &#8216;-&#8216;, values must be numeric. If <mop> is
&#8217;-&#8217; and it attempts to change a column value from negative to positive or
positive to negative, the column value is not modified.</li>
</ul>


<hr />

<p>Inserting data</p>

<p>The &#8216;insert&#8217; request has the following syntax.</p>

<pre><code>&lt;indexid&gt; + &lt;vlen&gt; &lt;v1&gt; ... &lt;vn&gt;
</code></pre>

<ul>
<li><vlen> indicates the length of the trailing parameters <v1> &#8230; <vn>. This
must be smaller than or equal to the length of <columns> specified by the
corresponding &#8216;open_index&#8217; request.</li>
<li><v1> &#8230; <vn> specify the column values to set. For columns not in
<columns>, the default values for each column are set.</li>
</ul>


<hr />

<p>Authentication</p>

<p>The &#8216;auth&#8217; request has the following syntax.</p>

<pre><code>A &lt;atyp&gt; &lt;akey&gt;
</code></pre>

<ul>
<li><atyp> must be &#8216;1&#8217;</li>
<li>An &#8216;auth&#8217; request succeeds iff <akey> is the correct secret specified by
the &#8216;handlersocket_plain_secret&#8217; or &#8216;handlersocket_plain_secret_rw&#8217;.</li>
<li>If an authentication is enabled for a listener, any other requests on a
connection fail before an &#8216;auth&#8217; request succeeded on the connection.</li>
</ul>


<hr />

<p>Response syntax</p>

<p>HandlerSocket returns a response of the following syntax for each request.</p>

<pre><code>&lt;errorcode&gt; &lt;numcolumns&gt; &lt;r1&gt; ... &lt;rn&gt;
</code></pre>

<ul>
<li><errorcode> indicates whether the request has successfully executed or not.
&#8216;0&#8217; means success. Non-zero means an error.</li>
<li><numcolumns> indicates the number of columns of the result set.</li>
<li><r1> &#8230; <rn> is the result set. The length of <r1> &#8230; <rn> is always a
multiple of <numcolumns>. It is possible that <r1> &#8230; <rn> is empty.</li>
</ul>


<p>If <errorcode> is non-zero, <numcolumns> is always 1 and <r1> indicates a
human-readable error message, though sometimes <r1> is not provided.</p>

<hr />

<p>Response for &#8216;open_index&#8217;</p>

<p>If &#8216;open_index&#8217; is succeeded, HandlerSocket returns a line of the following
syntax.</p>

<pre><code>0 1
</code></pre>

<hr />

<p>Response for &#8216;find&#8217;</p>

<p>If &#8216;find&#8217; is succeeded, HandlerSocket returns a line of the following
syntax.</p>

<p>   0 <numcolumns> <r1> &#8230; <rn></p>

<ul>
<li><numcolumns> always equals to the length of <columns> of the corresponding
&#8216;open_index&#8217; request.</li>
<li><r1> &#8230; <rn> is the result set. If N rows are found, the length of <r1>
&#8230; <rn> becomes ( <numcolumns> * N ).</li>
</ul>


<hr />

<p>Response for &#8216;find_modify&#8217;</p>

<p>If &#8216;find_modify&#8217; is succeeded, HandlerSocket returns a line of the following
syntax.</p>

<p>   0 1 <nummod></p>

<ul>
<li><nummod> is the number of modified rows.</li>
<li>As an exception, if the &#8216;?&#8217; suffix is specified in <mop>, a response has
the syntax of a response for &#8216;find&#8217; instead.</li>
</ul>


<hr />

<p>Response for &#8216;insert&#8217;</p>

<p>If &#8216;insert&#8217; is succeeded, HanderSocket returns a line of the following
syntax.</p>

<p>   0 1</p>

<hr />

<p>Response for &#8216;auth&#8217;</p>

<p>If &#8216;auth&#8217; is succeeded, HanderSocket returns a line of the following syntax.</p>

<p>   0 1</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      








  


<time datetime="2013-03-31T16:16:00+04:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://evsinev.github.com/blog/2013/03/31/handler-socket/" data-via="" data-counturl="http://evsinev.github.com/blog/2013/03/31/handler-socket/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/30/mysql-profiler/" title="Previous Post: mysql-profiler">&laquo; mysql-profiler</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/03/31/handler-socket/">handler-socket</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/30/mysql-profiler/">mysql-profiler</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/16/stm32-servo/">stm32-servo</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
